<!DOCTYPE html><html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-Control" content="no-cache">
	<meta http-equiv="Expires" content="0">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="referrer" content="no-referrer">
	<meta http-equiv="refresh" content="300;./">
	<title>Marker in Video by TwitchAPI</title>
	<link rel="stylesheet" type="text/css" href="https://n138-kz.github.io/lib/master.css?t=0">
	<script src="https://n138-kz.github.io/lib/master.js"></script>
	<script>
		window.addEventListener('DOMContentLoaded', ()=>{
			console.log(`init.`)
			console.log(`page-title: ${document.title}`);
			let item = null;
			item = document.createElement('h1');
			item.innerText = document.title;
			document.body.prepend(item);

			init_setFavicon('https://www.twitch.tv/', true);
		});
	</script>
	<style>
		label>input[type="checkbox"] {
			margin: 0;
			padding: 0;
		}
	</style>
	<script>
		let config={
			twitch: {
				"client_id": "61qmmbfstntv8v1k3a6xyvsrnylwgn",
				"redirect_uri": "https://api.n138.jp/twitch/",
				"scope": "channel:manage:broadcast",
			}
		};
	</script>
	<script>
		window.addEventListener('DOMContentLoaded', ()=>{
			let twitch_client_secret=localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.twitch.client_secret' );
			if(!(twitch_client_secret===null||twitch_client_secret===undefined||twitch_client_secret==='')){
				if(document.querySelectorAll('#twitchapi_request_token input[type="password"]').length===1){
					document.querySelector('#twitchapi_request_token input[type="password"]').value=twitch_client_secret;
				}
			}
		});
	</script>
</head>
<body>
	<div id="twitchapi_authorize">
		<a href="">twitch authorize</a>
		<script>
			window.addEventListener('DOMContentLoaded', async ()=>{
				let d=document.querySelector('#twitchapi_authorize>a');
				d.href='https://dev.twitch.tv/console';
				d.href='https://id.twitch.tv/oauth2/authorize';
				d.href+=`?client_id=${config.twitch.client_id}`;
				d.href+=`&redirect_uri=${document.location.origin}${document.location.pathname}`;
				d.href+=`&response_type=code`;
				d.href+=`&scope=${config.twitch.scope}`;
				d.href+=``;
			});
		</script>
		<script>
			let twitchapi={};
			window.addEventListener('DOMContentLoaded', async ()=>{
				let _get=get_GETarray((decodeURI(location.search)+'&').replace(/^\?/,''));
				_get.code=(_get.code===undefined||_get.code===null||_get.code==='')?'':_get.code;
				console.debug(_get);

				twitchapi={
					code: _get.code,
					user: undefined,
					videos: undefined,
					token: undefined,
				}

				console.debug(twitchapi);
			});
		</script>
		<script>
			async function twitchapi_getToken(item){
				item=item.parentNode;

				localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.twitch.client_secret', item.children.item(1).value );

				let d={
					client_id: config.twitch.client_id,
					client_secret: item.children.item(1).value,
					code: twitchapi.code,
					grant_type: 'authorization_code',
					redirect_uri: `${document.location.origin}${document.location.pathname}`,
				};

				try {
					activate_refresh_procedure.disabled=true;
					if(activate_refresh_procedure.parentNode.dataset.defaultStyleDisplay===undefined){
						activate_refresh_procedure.parentNode.dataset.defaultStyleDisplay=window.getComputedStyle(activate_refresh_procedure.parentNode).display;
					}
					activate_refresh_procedure.parentNode.style.display='none';
					activate_refresh_procedure.parentNode.style.removeProperty('color');
					activate_refresh_procedure.parentNode.style.color='silver';
				} catch (error) { console.error(error); }

				item.children.item(0).style.borderColor='#000000';
				item.children.item(0).style.backgroundColor='#ffffff';
				item.children.item(0).style.color='#000000';
				Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());

				try {
					let xhr=await fetch('https://id.twitch.tv/oauth2/token', {
						method: 'POST',
						headers: {'content-type': 'application/x-www-form-urlencoded'},
						body: new URLSearchParams(d),
					});
					let r=await xhr.json();
					console.debug('xhr result', r, await xhr.ok);
					if (!await xhr.ok) {
						throw new Error(`${xhr.status}: ${r.message}`);
					}

					let b=document.createElement('span');
					b.innerText=`${xhr.status}: token has issued`;
					b.style.color='#00aa00';
					b.id='errortext';
					item.appendChild(b);

					item.children.item(0).style.borderColor='#00ff00';
					item.children.item(0).style.backgroundColor='#00aa00';
					item.children.item(0).style.color='#ffffff';
					twitchapi.token=r;
					try {
						twitchapi.token.auto_refresh=activate_refresh_procedure.checked;
					} catch (error) {console.error(error);}
				} catch (error) {
					console.error(error);

					try {
						activate_refresh_procedure.disabled=false;
						activate_refresh_procedure.parentNode.style.display=activate_refresh_procedure.parentNode.dataset.defaultStyleDisplay;
						activate_refresh_procedure.parentNode.style.removeProperty('color');
					} catch (error) { console.error(error); }

					let b=document.createElement('span');
					b.innerText=error;
					b.style.color='#ff0000';
					b.id='errortext';
					item.appendChild(b);

					item.children.item(0).style.borderColor='#ff0000';
					item.children.item(0).style.backgroundColor='#aa0000';
					item.children.item(0).style.color='#ffffff';
				}
			}
			async function twitchapi_getUserInfo(item=undefined){
				if (item!==undefined) {
					item.children.item(0).style.borderColor='#000000';
					item.children.item(0).style.backgroundColor='#ffffff';
					item.children.item(0).style.color='#000000';
					Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());
				}

				let result = undefined;
				let request_params={
					item:undefined,
					client_id:undefined,
					code:undefined,
				};
				request_params.item='get-userinfo';
				request_params.client_id=config.twitch.client_id;
				request_params.code=twitchapi.token.access_token;
				request_params=JSON.stringify(request_params);

				let api={
					url: undefined,
					method: 'GET',
					headers: {
						"Content-Type": 'application/json',
					}
				}
				api.url=`./contents/?item=${request_params}`;
				console.debug(`api.url: ${api.url}`);

				try {
					let xhr=await fetch(api.url, {
						method: api.method,
						headers: api.headers,
						mode: 'no-cors',
					});

					let r=await xhr.json();
					console.debug('xhr result', r, await xhr.ok);
					if (!await xhr.ok) {
						throw new Error(`${xhr.status}: ${r.message}`);
					}
					result=r;

					if (item!==undefined) {
						let b=document.createElement('span');
						b.innerText=`${xhr.status} uid: ${r.id}`;
						b.style.color='#00aa00';
						b.id='errortext';
						item.appendChild(b);

						item.children.item(0).style.borderColor='#00ff00';
						item.children.item(0).style.backgroundColor='#00aa00';
						item.children.item(0).style.color='#ffffff';
					}
				} catch (error) {
					console.error(error);
					let b=document.createElement('span');
					b.innerText=error;
					b.style.color='#ff0000';
					b.id='errortext';
					item.appendChild(b);

					if (item!==undefined) {
						item.children.item(0).style.borderColor='#ff0000';
						item.children.item(0).style.backgroundColor='#aa0000';
						item.children.item(0).style.color='#ffffff';
					}
					return false;
				}

				return result;
			}

			async function twitchapi_getlivestatus(id='', item=undefined){
				if (item!==undefined) {
					item.children.item(0).style.borderColor='#000000';
					item.children.item(0).style.backgroundColor='#ffffff';
					item.children.item(0).style.color='#000000';
					Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());
				}

				let result = undefined;
				let request_params={
					item:undefined,
					client_id:undefined,
					code:undefined,
					id: undefined,
				};
				request_params.item='get-livestatus';
				request_params.client_id=config.twitch.client_id;
				request_params.code=twitchapi.token.access_token;
				request_params.id=id;
				request_params=JSON.stringify(request_params);

				let api={
					url: undefined,
					method: 'GET',
					headers: {
						"Content-Type": 'application/json',
					}
				}
				api.url=`./contents/?item=${request_params}`;
				console.debug(`api.url: ${api.url}`);

				try {
					let xhr=await fetch(api.url, {
						method: api.method,
						headers: api.headers,
						mode: 'no-cors',
					});

					let r=await xhr.json();
					console.debug('xhr result', r, await xhr.ok);
					if (!await xhr.ok) {
						throw new Error(`${xhr.status}: ${r.message}`);
					}
					result=r;
				} catch (error) {
					console.error(error);
					let b=document.createElement('span');
					b.innerText=error;
					b.style.color='#ff0000';
					b.id='errortext';
					item.appendChild(b);

					if (item!==undefined) {
						item.children.item(0).style.borderColor='#ff0000';
						item.children.item(0).style.backgroundColor='#aa0000';
						item.children.item(0).style.color='#ffffff';
					}
					return false;
				}

				return result;
			}

			async function twitchapi_getVideos(id='', item=undefined){
				if (item!==undefined) {
					item.children.item(0).style.borderColor='#000000';
					item.children.item(0).style.backgroundColor='#ffffff';
					item.children.item(0).style.color='#000000';
					Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());
				}

				let result = undefined;
				let request_params={
					item:undefined,
					client_id:undefined,
					code:undefined,
					id: undefined,
				};
				request_params.item='get-videos';
				request_params.client_id=config.twitch.client_id;
				request_params.code=twitchapi.token.access_token;
				request_params.id=id;
				request_params=JSON.stringify(request_params);

				let api={
					url: undefined,
					method: 'GET',
					headers: {
						"Content-Type": 'application/json',
					}
				}
				api.url=`./contents/?item=${request_params}`;
				console.debug(`api.url: ${api.url}`);

				try {
					let xhr=await fetch(api.url, {
						method: api.method,
						headers: api.headers,
						mode: 'no-cors',
					});

					let r=await xhr.json();
					console.debug('xhr result', r, await xhr.ok);
					if (!await xhr.ok) {
						throw new Error(`${xhr.status}: ${r.message}`);
					}
					result=r;

					if (item!==undefined) {
						let b=document.createElement('span');
						b.innerText=`${xhr.status} videos(${r.length}): meta loading`;
						b.style.color='#00aa00';
						b.id='errortext';
						item.appendChild(b);

						item.children.item(0).style.borderColor='#00ff00';
						item.children.item(0).style.backgroundColor='#00aa00';
						item.children.item(0).style.color='#ffffff';
					}
				} catch (error) {
					console.error(error);
					let b=document.createElement('span');
					b.innerText=error;
					b.style.color='#ff0000';
					b.id='errortext';
					item.appendChild(b);

					if (item!==undefined) {
						item.children.item(0).style.borderColor='#ff0000';
						item.children.item(0).style.backgroundColor='#aa0000';
						item.children.item(0).style.color='#ffffff';
					}
					return false;
				}

				return result;
			}

			async function twitchapi_getVideoMarker(id='', item=undefined){
				if (item!==undefined) {
					item.children.item(0).style.borderColor='#000000';
					item.children.item(0).style.backgroundColor='#ffffff';
					item.children.item(0).style.color='#000000';
					Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());
				}

				let result = undefined;
				let request_params={
					item:undefined,
					client_id:undefined,
					code:undefined,
					id: undefined,
				};
				request_params.item='get-markers';
				request_params.client_id=config.twitch.client_id;
				request_params.code=twitchapi.token.access_token;
				request_params.id=id;
				request_params=JSON.stringify(request_params);

				let api={
					url: undefined,
					method: 'GET',
					headers: {
						"Content-Type": 'application/json',
					}
				}
				api.url=`./contents/?item=${request_params}`;
				console.debug(`api.url: ${api.url}`);

				try {
					let xhr=await fetch(api.url, {
						method: api.method,
						headers: api.headers,
						mode: 'no-cors',
					});

					let r=await xhr.json();
					console.debug('xhr result', r, await xhr.ok);
					if (!await xhr.ok) {
						throw new Error(`${xhr.status}: ${r.message}`);
					}
					result=r;

					if (item!==undefined) {
						let b=document.createElement('span');
						b.innerText=`${xhr.status} videos(${id}): loading`;
						b.style.color='#00aa00';
						b.id='errortext';
						item.appendChild(b);

						item.children.item(0).style.borderColor='#00ff00';
						item.children.item(0).style.backgroundColor='#00aa00';
						item.children.item(0).style.color='#ffffff';
					}
				} catch (error) {
					console.error(error);
					let b=document.createElement('span');
					b.innerText=error;
					b.style.color='#ff0000';
					b.id='errortext';
					item.appendChild(b);

					if (item!==undefined) {
						item.children.item(0).style.borderColor='#ff0000';
						item.children.item(0).style.backgroundColor='#aa0000';
						item.children.item(0).style.color='#ffffff';
					}
					return false;
				}

				return result;
			}

			async function twitchapi_getContents(item){
				item=item.parentNode;

				item.children.item(0).style.borderColor='#000000';
				item.children.item(0).style.backgroundColor='#ffffff';
				item.children.item(0).style.color='#000000';
				Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());

				twitchapi.user=await twitchapi_getUserInfo(item);
				twitchapi.user.livestatus=await twitchapi_getlivestatus(twitchapi.user.id, item);
				twitchapi.user.islive=twitchapi.user.livestatus.type==='live';
				twitchapi.videos=await twitchapi_getVideos(twitchapi.user.id, item);

				if (item!==undefined) {
					item.children.item(0).style.borderColor='#000000';
					item.children.item(0).style.backgroundColor='#ffffff';
					item.children.item(0).style.color='#000000';
					Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());
				}

				twitchapi_itemshown('user', true);

				if (item!==undefined) {
					let b=document.createElement('span');
					b.innerText=`videos ${twitchapi.videos.length} loading`;
					b.style.color='#00aa00';
					b.id='errortext';
					item.appendChild(b);

					item.children.item(0).style.borderColor='#00ff00';
					item.children.item(0).style.backgroundColor='#00aa00';
					item.children.item(0).style.color='#ffffff';
				}

				for(let i=0;i<twitchapi.videos.length;i++){
					twitch_video_markers=await twitchapi_getVideoMarker(twitchapi.videos[i].id);
					twitch_video_markers=twitch_video_markers.markers;
					console.debug('twitch_video_markers', twitch_video_markers);
					console.debug('twitch_video_markers', 'Array.isArray', Array.isArray(twitch_video_markers));
					try {
						if (!Array.isArray(twitch_video_markers)) {
							twitch_video_markers=[];
						}
						twitch_video_markers.unshift({
							URL: `https://twitch.tv/yuukomiya/manager/highlighter/${twitchapi.videos[i].id}?t=0`,
							created_at: `${twitchapi.videos[i].created_at}`,
							description: `Created by ${location.host}`,
							id: null,
							position_seconds: 0,
						});
					} catch (error) {
						Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());
						console.error(error);
						
						let b=document.createElement('span');
						b.innerText=error;
						b.style.color='#ff0000';
						b.id='errortext';
						item.appendChild(b);

						item.children.item(0).style.borderColor='#ff0000';
						item.children.item(0).style.backgroundColor='#aa0000';
						item.children.item(0).style.color='#ffffff';
					}
					twitchapi.videos[i].markers=twitch_video_markers;
				}
				console.debug(twitchapi);

				if (item!==undefined) {
					Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());

					let b=document.createElement('span');
					b.innerText=`videos ${twitchapi.videos.length} loaded`;
					b.style.color='#00aa00';
					b.id='errortext';
					item.appendChild(b);

					item.children.item(0).style.borderColor='#00ff00';
					item.children.item(0).style.backgroundColor='#00aa00';
					item.children.item(0).style.color='#ffffff';
				}

				twitchapi_itemshown('videos');
				return false;
			}
			async function twitchapi_itemshown(object='',cleanup=false){
				const export_to=document.getElementById('twitch_videos');
				if (cleanup===true) {
					Array.from(document.getElementById('twitch_videos').children).map(e=>e.remove());
				}
				Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());

				let item=[];
				switch (object) {
					case 'user':
						item[0]=document.createElement('div');
						item[1]=document.createElement('a');
						item[1].href=`https://www.twitch.tv/${twitchapi.user.login}`;
						item[2]=document.createElement('img');
						item[2].src=twitchapi.user.profile_image_url;
						item[2].alt=`https://www.twitch.tv/${twitchapi.user.login}`;
						item[2].style.maxWidth='3em';
						item[1].appendChild(item[2]);
						item[0].appendChild(item[1]);
						item[1]=document.createElement('span');
						item[1].innerText=(twitchapi.user.islive)?'<LIVE>':null;
						item[0].appendChild(item[1]);
						export_to.appendChild(item[0]);
						break;
					case 'videos':
						item[0]=document.createElement('div');
						item[1]=document.createElement('table');
						item[1].style.borderStyle='dotted';
						item[1].style.borderColor='#000';
						item[1].style.borderWidth='1px';
						item[1].style.fontSize='9pt';
						item[2]=document.createElement('tr');
						[
							'#',
							'タイトル',
							'公開日',
							'言語',
							'Duration',
							'Markers',
						].map(e=>{
							item[3]=document.createElement('th');
							item[3].style.borderStyle='solid';
							item[3].style.borderColor='#000';
							item[3].style.borderWidth='1px';
							item[3].innerText=e;
							item[3].style.textAlign='center';
							item[2].appendChild(item[3]);
						});
						item[1].appendChild(item[2]);

						for(let i=0;i<twitchapi.videos.length;i++){
							item[2]=document.createElement('tr');
							item[3]=document.createElement('th');
							item[3].style.borderStyle='solid';
							item[3].style.borderColor='#000';
							item[3].style.borderWidth='1px';
							item[3].innerText=i;
							item[3].style.textAlign='right';
							item[2].appendChild(item[3]);

							item[3]=document.createElement('td');
							item[3].style.borderStyle='solid';
							item[3].style.borderColor='#000';
							item[3].style.borderWidth='1px';
							item[4]=document.createElement('a');
							item[4].href=twitchapi.videos[i].url;
							item[5]=document.createElement('span');
							item[5].innerText=twitchapi.videos[i].title;
							item[4].appendChild(item[5]);
							item[5]=document.createElement('br');
							item[4].appendChild(item[5]);
							item[5]=document.createElement('img');
							item[5].src=twitchapi.videos[i].thumbnail_url.replace('%{width}', '192').replace('%{height}', '108');
							if(i===0&&twitchapi.user.islive){
								item[5].src=twitchapi.user.livestatus.thumbnail_url.replace('{width}', '192').replace('{height}', '108');
							}else{
								item[5].setAttribute('onerror', 'console.warn(`Traped img.onerror. URL:${this.src}`);this.remove();');
							}
							item[4].appendChild(item[5]);
							item[3].appendChild(item[4]);
							item[3].style.textAlign='left';
							item[2].appendChild(item[3]);

							item[3]=document.createElement('td');
							item[3].style.borderStyle='solid';
							item[3].style.borderColor='#000';
							item[3].style.borderWidth='1px';
							item[4]=document.createElement('div');
							item[4].style.whiteSpace='nowrap';
							item[4].innerText=`${new Date(twitchapi.videos[i].published_at).toLocaleDateString()} ${new Date(twitchapi.videos[i].published_at).toLocaleTimeString()}`;
							item[3].appendChild(item[4]);
							item[3].style.textAlign='left';
							item[2].appendChild(item[3]);

							item[3]=document.createElement('td');
							item[3].style.borderStyle='solid';
							item[3].style.borderColor='#000';
							item[3].style.borderWidth='1px';
							item[4]=document.createElement('img');
							item[4].alt=twitchapi.videos[i].language;
							item[4].src=`./logo/${twitchapi.videos[i].language}.svg`;
							item[3].appendChild(item[4]);
							item[3].style.textAlign='left';
							item[2].appendChild(item[3]);

							item[3]=document.createElement('td');
							item[3].style.borderStyle='solid';
							item[3].style.borderColor='#000';
							item[3].style.borderWidth='1px';
							item[3].innerText=twitchapi.videos[i].duration.replace(/(d|h|m)/gi, ':').replace('s', '').split(':').map(s => s.padStart(2, '0')).join(':');
							item[3].style.textAlign='right';
							item[2].appendChild(item[3]);

							item[3]=document.createElement('td');
							item[3].style.borderStyle='solid';
							item[3].style.borderColor='#000';
							item[3].style.borderWidth='1px';
							if (twitchapi.videos[i].markers===undefined) {
								item[3].innerText='';
							}else{
								item[4]=document.createElement('div');
								twitchapi.videos[i].markers.map(e=>{
									item[5]=document.createElement('p');
									item[5].style.whiteSpace='nowrap';
									item[6]=document.createElement('span');
									item[6].innerText='- ';
									item[5].appendChild(item[6]);
									item[6]=document.createElement('a');
									item[6].href=e.URL;
									item[6].dataset.created_at=e.created_at;
									e.description=(e.description.length>0)?e.description:'Created by Twitch console';
									item[6].dataset.description=e.description;
									item[6].dataset.id=e.id;
									item[6].dataset.video=twitchapi.videos[i].url;
									t={p:e.position_seconds};
									t.h=parseInt(t.p/3600);
									t.m=parseInt((t.p%3600)/60);
									t.s=((t.p%3600)%60);
									t.f=`${t.h}:${t.m}:${t.s}`.split(':').map(s => s.padStart(2, '0')).join(':');
									item[6].dataset.position_seconds=e.position_seconds;
									item[6].dataset.position_seconds_query=`${t.h}h${t.m}m${t.s}s`;
									item[6].href=`${twitchapi.videos[i].url}?t=${t.h}h${t.m}m${t.s}s`;
									item[6].innerText=`${t.f} ${e.description}`;
									item[5].appendChild(item[6]);
									item[4].appendChild(item[5]);
								});
								item[3].appendChild(item[4]);
							}
							item[3].style.textAlign='left';
							item[2].appendChild(item[3]);

							item[1].appendChild(item[2]);
						}
						item[0].appendChild(item[1]);
						export_to.appendChild(item[0]);
						break;
					default:
				}
			}
		</script>
	</div>
	<div>
		<form id="twitchapi_request_token_refresh">
			<label>
				<input type="checkbox" id="activate_refresh_procedure" data-lang-en="Auto Refresh Token" onclick="if(this.checked===false){location.replace(location.origin+location.pathname);}">トークン自動更新
			</label>
		</form>
		<table>
			<tr>
				<td>
					<form id="twitchapi_request_token">
						<input type="button" value="トークン取得" onclick="twitchapi_getToken(this);">
						<input type="password" value="secret-key" placeholder="Input the client_secret" onclick="this.select();">
					</form>
				</td>
			</tr>
			<tr>
				<td>
					<form id="twitchapi_request_token">
						<input type="button" value="動画一覧取得" onclick="twitchapi_getContents(this)">
						<!--
						<input type="text" value="twitchdev" placeholder="Input the login_name">
						-->
					</form>
				</td>
			</tr>
		</table>
	</div>
	<div id="twitch_videos"></div>
	<p>
		<a href="./settei_tool/">設定ツール</a>
	</p>
</body>
</html>
