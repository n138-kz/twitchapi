<!DOCTYPE html><html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-Control" content="no-cache">
	<meta http-equiv="Expires" content="0">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="referrer" content="no-referrer">
	<meta http-equiv="refresh" content="300">
	<title>Marker in Video by TwitchAPI</title>
	<link rel="stylesheet" type="text/css" href="https://n138-kz.github.io/lib/master.css?t=0">
	<script src="https://n138-kz.github.io/lib/master.js"></script>
	<script>
		window.addEventListener('DOMContentLoaded', ()=>{
			console.log(`init.`)
			console.log(`page-title: ${document.title}`);
			let item = null;
			item = document.createElement('h1');
			item.innerText = document.title;
			document.body.prepend(item);
		});
	</script>
	<script>
		let config={
			twitch: {
				"client_id": "61qmmbfstntv8v1k3a6xyvsrnylwgn",
				"redirect_uri": "https://api.n138.jp/twitch/",
				"scope": "channel:manage:broadcast",
			}
		};
	</script>
</head>
<body>
	<div id="twitchapi_authorize">
		<a href="">twitch authorize</a>
		<script>
			window.addEventListener('DOMContentLoaded', async ()=>{
				let d=document.querySelector('#twitchapi_authorize>a');
				d.href='https://dev.twitch.tv/console';
				d.href='https://id.twitch.tv/oauth2/authorize';
				d.href+=`?client_id=${config.twitch.client_id}`;
				d.href+=`&redirect_uri=${document.location.origin}${document.location.pathname}`;
				d.href+=`&response_type=code`;
				d.href+=`&scope=${config.twitch.scope}`;
				d.href+=``;
			});
		</script>
		<script>
			let twitchapi={};
			window.addEventListener('DOMContentLoaded', async ()=>{
				let _get=get_GETarray((decodeURI(location.search)+'&').replace(/^\?/,''));
				_get.code=(_get.code===undefined||_get.code===null||_get.code==='')?'':_get.code;
				console.debug(_get);

				twitchapi={
					code: _get.code,
					access_token: undefined,
				}
				
				console.debug(twitchapi);
			});
		</script>
		<script>
			async function twitchapi_getToken(item){
				item=item.parentNode;
				
				let d={
					client_id: config.twitch.client_id,
					client_secret: item.children.item(1).value,
					code: twitchapi.code,
					grant_type: 'authorization_code',
					redirect_uri: `${document.location.origin}${document.location.pathname}`,
				};
				console.log(d);

				item.children.item(0).style.borderColor='#000000';
				item.children.item(0).style.backgroundColor='#ffffff';
				item.children.item(0).style.color='#000000';
				Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());
				
				try {
					let x=await fetch('https://id.twitch.tv/oauth2/token', {
						method: 'POST',
						headers: {'content-type': 'application/x-www-form-urlencoded'},
						body: new URLSearchParams(d),
					});
					let r=await x.json();
					console.log(r, await x.ok);
					if (!await x.ok) {
						throw new Error(`${x.status}: ${r.message}`);
					}
					
					let b=document.createElement('span');
					b.innerText=`${x.status}: token has issued`;
					b.style.color='#00aa00';
					b.id='errortext';
					item.appendChild(b);
	
					item.children.item(0).style.borderColor='#00ff00';
					item.children.item(0).style.backgroundColor='#00aa00';
					item.children.item(0).style.color='#ffffff';
					twitchapi.access_token=r.access_token;
				} catch (error) {
					console.error(error);
					let b=document.createElement('span');
					b.innerText=error;
					b.style.color='#ff0000';
					b.id='errortext';
					item.appendChild(b);

					item.children.item(0).style.borderColor='#ff0000';
					item.children.item(0).style.backgroundColor='#aa0000';
					item.children.item(0).style.color='#ffffff';
				}
			}
			async function twitchapi_getUserInfo(item=undefined){
				if (item!==undefined) {
					item.children.item(0).style.borderColor='#000000';
					item.children.item(0).style.backgroundColor='#ffffff';
					item.children.item(0).style.color='#000000';
					Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());
				}

				let request_params={
					item:undefined,
					client_id:undefined,
					code:undefined,
				};
				request_params.item='get-userinfo';
				request_params.client_id=config.twitch.client_id;
				request_params.code=twitchapi.access_token;
				request_params=JSON.stringify(request_params);

				let api={
					url: undefined,
					method: 'GET',
					headers: {
						"Content-Type": 'application/json',
					}
				}
				api.url=`./contents/?item=${request_params}`;
				console.log(api.url);

				let result = undefined;
				try {
					let xhr=await fetch(api.url, {
						method: api.method,
						headers: api.headers,
						mode: 'no-cors',
					});

					let r=await xhr.json();
					console.log(r, await xhr.ok);
					if (!await xhr.ok) {
						throw new Error(`${xhr.status}: ${r.message}`);
					}
					result=r;
					
					if (item!==undefined) {
						let b=document.createElement('span');
						b.innerText=`${xhr.status} uid: ${r.id}`;
						b.style.color='#00aa00';
						b.id='errortext';
						item.appendChild(b);
		
						item.children.item(0).style.borderColor='#00ff00';
						item.children.item(0).style.backgroundColor='#00aa00';
						item.children.item(0).style.color='#ffffff';
					}
				} catch (error) {
					console.error(error);
					let b=document.createElement('span');
					b.innerText=error;
					b.style.color='#ff0000';
					b.id='errortext';
					item.appendChild(b);

					if (item!==undefined) {
						item.children.item(0).style.borderColor='#ff0000';
						item.children.item(0).style.backgroundColor='#aa0000';
						item.children.item(0).style.color='#ffffff';
					}
					return false;
				}

				return result;
			}

			async function twitchapi_getVideos(item){
				item=item.parentNode;

				item.children.item(0).style.borderColor='#000000';
				item.children.item(0).style.backgroundColor='#ffffff';
				item.children.item(0).style.color='#000000';
				Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());

				twitchapi.user=await twitchapi_getUserInfo(item);
				console.log(twitchapi);
				return false;

				let h={
					Authorization: `Bearer ${twitchapi.access_token}`,
					"Client-Id": config.twitch.client_id,
				}
				console.log({url: `https://api.twitch.tv/helix/users?login=${item.children.item(1).value}`, headers: h});

				console.log(`curl -s -H 'Authorization: Bearer ${twitchapi.access_token}' -H 'Client-Id: ${config.twitch.client_id}' https://api.twitch.tv/helix/users?login=${item.children.item(1).value}`);
				
				item.children.item(0).style.borderColor='#000000';
				item.children.item(0).style.backgroundColor='#ffffff';
				item.children.item(0).style.color='#000000';
				Array.from(document.querySelectorAll('#errortext')).map(e=>e.remove());
				
				try {
					let x=await fetch(`https://api.twitch.tv/helix/users?login=${item.children.item(1).value}`, {
						method: 'GET',
						headers: h,
						mode: 'no-cors',
					});
					let r=await x.json();
					console.log(r, await x.ok);
					if (!await x.ok) {
						throw new Error(`${x.status}: ${r.message}`);
					}
					
					let b=document.createElement('span');
					b.innerText=`${x.status}`;
					b.style.color='#00aa00';
					b.id='errortext';
					item.appendChild(b);
	
					item.children.item(0).style.borderColor='#00ff00';
					item.children.item(0).style.backgroundColor='#00aa00';
					item.children.item(0).style.color='#ffffff';
				} catch (error) {
					console.error(error);
					let b=document.createElement('span');
					b.innerText=error;
					b.style.color='#ff0000';
					b.id='errortext';
					item.appendChild(b);

					item.children.item(0).style.borderColor='#ff0000';
					item.children.item(0).style.backgroundColor='#aa0000';
					item.children.item(0).style.color='#ffffff';
					return false;
				}
			}
		</script>
	</div>
	<div>
		<table>
			<tr>
				<td>
					<form id="twitchapi_request_token">
						<input type="button" value="トークン取得" onclick="twitchapi_getToken(this)">
						<input type="password" value="secret-key" placeholder="Input the client_secret" onclick="this.select();">
					</form>
				</td>
			</tr>
			<tr>
				<td>
					<form id="twitchapi_request_token">
						<input type="button" value="動画一覧取得" onclick="twitchapi_getVideos(this)">
						<!--
						<input type="text" value="twitchdev" placeholder="Input the login_name">
						-->
					</form>
				</td>
			</tr>
		</table>
	</div>
	<p>
		<a href="./settei_tool/">設定ツール</a>
	</p>
</body>
</html>